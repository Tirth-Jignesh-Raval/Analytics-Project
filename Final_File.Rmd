---
title: "Analytics Project - Wellbeing Data Set"
subtitle: "C755: Analytics & Decision-Making in Healthcare"
author:
  name: Tahir Abdulrehman, Nancy Du, Tony Nguyen, Tirth Raval
  affiliation: C755 | DeGroote School of Business, McMaster University
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document: 
    number_sections: FALSE
    code_folding: hide
    toc: yes
    toc_float: 
      toc_collapsed: true
    theme: readable
    warning: false
---


# Load the Libraries 

```{r "load libraries"}
pacman::p_load(psych, xray , ggplot2, texreg, DT, wrapr, dplyr,
               sjmisc, sjlabelled, sjstats, sjPlot, tidyr,ggpubr,corrplot,
               knitr, kableExtra, captioner, car, excelR,ggcorrplot,Rmisc,sjmisc,funModeling,
               forcats, hrbrthemes,tidyverse,finalfit,patchwork,GGally,broom,caret,matrixTests,
               PerformanceAnalytics, pROC, rattle, finalfit, xgboost, randomForest)



```  


# Connect the Dataset
```{r}
df = read.csv("Well_being_Health_Behavior_Environmental_Fact.csv")
```


# First Glance of the Data set

## Head View of the Data Set
```{r}
pacman::p_load("DT")
head(x = df,n=5) %>% datatable(rownames=TRUE,filter = "top", options=list(pageLength = 10, scrollX=T))
```


## Tail View of the Dataset

```{r}
pacman::p_load("DT")
tail(x = df,n=5) %>% datatable(rownames=TRUE,filter = "top", options=list(pageLength = 10, scrollX=T))
```

## Head Tail View of the DataSet
```{r}
pacman::p_load("DT","psych")
headTail(x = df,top = 4,bottom = 4) %>% datatable(rownames=TRUE,filter = "top", options=list(pageLength = 10, scrollX=T,scrollY=T))
```



# Scrutinizing the Data

## 3S of the Dataset

### Size of the Dataset
```{r}
cat("The Dataset (df) contains ",nrow(df)," records and", ncol(df)," Columns or variables.")
```

### Structure of the Data Set
```{r}
str(df)
```
<br><br><br>

<h3> Interpretation from the Structure of the Dataset : </h3> <br><br>

1. The Dataset originally has only numerical and integer values<br>

2. <b>Our Target variable "wellbeing" is also an integer datatype. </b>However, we expect that into a category as we conceive it as classification thing of Wellbeing in the form of category as (yes or no) or (good or bad).
<br>
<mark style ="background-color:#faed27">
2.Action : Convert "Wellbeing" into a factor </mark><br>


3. It is also evident by looking at the structure of the dataset that <b>several other variables like (Asthma, HealthInsurance, CVD, Diabetes, HeavyDrinker) to name a few are supposed to be categories or factors but infact they are integers.</b><br>
<mark style ="background-color:#faed27">
3.Action : Convert those set of Categorical Variables as Factors from Integers.</mark>

4. Some set of variables are of the perfect type for example - Age is an integer and is supposed to be one. PM2.5 which represents the Fine Particle Matter in micrograms/cubic meter is actually a numerical data in a continous form.

5. Some Variables such as BMI and income were expected to be continuous. However, they are ordinal values mentioned in integers which is a point of concern

<mark style ="background-color:#faed27">
5. Action : Convert those variables into probable factors whenver needed in Analytics
</mark>



### Summary of the DataSet

```{r}
summary(df)
```

<br><br><br>

<h3> Interpretation from the Structure of the Dataset : </h3> <br><br>

1. The Summary provides a good support of evidence for those points of concerns expressed earlier in the structure of the dataset. <b>It describes the standard statistics for those variables which are supposed to be categorical variables either ordinal or nominal </b>
<br> 
2. <mark style ="background-color:#faed27"> The Summary indicates something interesting that many records and most variables in the dataset contains null values.  </mark><br>

2. <mark style ="background-color:#faed27"> Action : Either Remove or Impute Null Values ensuring that in each of the case does not statistically significantly alters the dataset.</mark><br>

3. The Good part that the summary iterates is that the almost all variables are within their supposed range. For an instance, no age record is negative, No PM2.5 less than 0, Household income min is not negative and so on. This is a sigh of relief.

Below are some boxplots for concerning continuous and discrete variables demonstrating their ranges with outliers


## Boxplots For Range Check and Outlier Detection


### Age Boxplot
```{r echo=FALSE}
boxplot(df["age"],main = "age Box Plot", xlab = "Age",horizontal = TRUE)
```


This boxplot for age seems very healthy. In the original BRFSS dataset, ages 7 and 9 were designated for mising values.    
    
    
    

### Premature Mortality Boxplot
```{r}
boxplot(df["PrematureMortality"],main = "Premature Mortality Box Plot", xlab = "Premature Mortality",horizontal = TRUE)
```

The distribution of the Premature Mortality have some outliers in the right ends shows that it is skewed to the right.

#### Checking Distribution of Premature Mortality

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=PrematureMortality)) + geom_density()+
 ggtitle ("Premature Mortality Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.




From the above test, we could possibly reject the null hypothesis that the distribution of premature Mortality is normal. However through Central Limit Theorem I shall prove the normality.

```{r}
s30 <- c()
s50 <- c()
s500 <- c()
n =396000
for ( i in 1:n){
s30[i] = mean(sample(df$PrematureMortality,30, replace = TRUE))
s50[i] = mean(sample(df$PrematureMortality,50, replace = TRUE))
s500[i] = mean(sample(df$PrematureMortality,500, replace = TRUE))
}
par(mfrow=c(1,3))
hist(s30, col ="lightblue",main="Sample size=30",xlab ="Premature Mortality")
abline(v = mean(s30), col = "red")

hist(s50, col ="lightgreen", main="Sample size=50",xlab ="Premature Mortality")
abline(v = mean(s50), col = "red")

hist(s500, col ="orange",main="Sample size=500",xlab ="Premature Mortality")
abline(v = mean(s500), col = "red")

```

<h3> Interpretation </h3>

We could clearly see a bell curve with Central Limit Theorem and prove that with sufficiently large sample size any distribution that does not seem to be normally distributed gets normally distributed using Central Limit Theorem or Bootstrapping.


### Household Income Boxplot
```{r}
boxplot(df["HouseholdIncome"],main = "Household Income Box Plot", xlab = "Household Income",horizontal = TRUE)
```
The distribution of the Household Income have some outliers in the right ends shows that it is skewed to the right.

#### Checking Distribution of Household Income

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=HouseholdIncome)) + geom_density()+
 ggtitle ("Household Income Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```
The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.

<br>

<mark style ="background-color:#faed27"> So from now on we shall not Check with the CLT or Bootstrapping for the normal distribution of any variable rather assume that the distribution will be normal whenever viewed from the lens of CLT or Bootstrapping.
</mark>

### Unemployment Rate   Boxplot
```{r}
boxplot(df["UnemploymentRate"],main = "Unemployment Rate   Box Plot", xlab = "Unemployment Rate  ",horizontal = TRUE)
```
The distribution of the Unemployment Rate have some outliers on both ends more probably on the right which signifies that it is skewed more to the right.

#### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=UnemploymentRate)) + geom_density()+
 ggtitle ("Unemployment Rate Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.



### High School Rate Boxplot
```{r}
boxplot(df["HighSchoolRate"],main = "High School Rate Box Plot", xlab = "High School Rate",horizontal = TRUE)
```
The distribution of the High School Rate have some outliers on left ends which signifies that it is skewed more to the left.

### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=HighSchoolRate)) + geom_density()+
 ggtitle ("High School Rate Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.

### Some College Rate Boxplot
```{r}
boxplot(df["SomeCollegeRate"],main = "Some College Rate Box Plot", xlab = "Some College Rate  ",horizontal = TRUE)
```
The distribution of the Some College Rate have some outliers on left ends which signifies that it is skewed more to the left.

#### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=SomeCollegeRate)) + geom_density()+
 ggtitle ("Some College Rate Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.


### Access To Recreational Facility Boxplot
```{r}
boxplot(df["AccessToRecFacility"],main = "Access To Recreational Facility Box Plot", xlab = "Access To Recreational Facility  ",horizontal = TRUE)
```
The distribution of the Access To Recreational Facility have some outliers on right ends which signifies that it is skewed more to the left.

#### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=AccessToRecFacility)) + geom_density()+
 ggtitle ("Access To Recreational Facility Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.


### Fast Food Percentage Boxplot
```{r}
boxplot(df["FastFoodPercentage"],main = "Fast Food Percentage Box Plot", xlab = "Fast Food Percentage  ",horizontal = TRUE)
```
The distribution of the Fast Food Percentage have some outliers on both ends 

#### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=FastFoodPercentage)) + geom_density()+
 ggtitle ("Fast Food Percentage Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution seems normal with multiple peaks and higher kurtosis



### PM2.5 Boxplot
```{r}
boxplot(df["PM2.5"],main = "PM2.5 Box Plot", xlab = "PM2.5  ",horizontal = TRUE)
```
The distribution of the PM2.5 have some outliers on left ends which signifies that it is skewed more to the left.

#### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=PM2.5)) + geom_density()+
 ggtitle ("PM2.5 Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.

### Population Density Boxplot
```{r}
boxplot(df["PopulationDensity"],main = "Population Density Box Plot", xlab = "Population Density  ",horizontal = TRUE)
```
The distribution of the Population Density have some outliers on right ends which signifies that it is skewed more to the right

#### Checking Distribution of Unemployment Rate 

```{r}
pacman::p_load("ggplot2")
ggplot(data=df,aes(x=PopulationDensity)) + geom_density()+
 ggtitle ("Population Density Density Plot") +
theme (axis.title.x=element_text (size=16, face="bold", colour="blue")) +
theme (axis.text.x=element_text (size=14 ) ) 
```

The distribution does not seems normal but I suspect that when we apply the CLT or Bootstrapping Normality would be proven.


### Interpretation of Boxplots for every variable
<br><br>
As far as continuous variables are concerned their distribution is quite questionable however, with Central Limit Theorem it could be deduced that they are representative of their population. 
<br>
Also the boxplot help us indicates that the variables are in their expected range and have acceptable set of outliers and shall help us validate the min, max, median and range of those variables.



## Inspect the presence and purview of null values

### recoding missing values for age
```{r}
# remove missing age values  
df <- df %>% 
  mutate(age = na_if(age, 7)) %>%
  mutate(age = na_if(age, 9))
```

### Checking the count of null values by Variable

```{r}
apply(apply(df,2,is.na),2,sum)
```

### Plotting the null values by variable

```{r}
library(tidyr)
pacman::p_load(inspectdf)
df %>% inspect_na %>% show_plot
```

#### Plot only variables with null values    
```{r}
df[,c(2:21,24,25,27,28,31)] %>% inspect_na %>% show_plot +
  ggtitle("Prevalence of Missing Values in the Dataset") +
  ylab("% of variable that is NA") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1))
```


### Check the rows with null values

```{r}
sum(apply(df,1,anyNA))
```
```{r}
cat("There are around ",sum(apply(df,1,anyNA)), " null records in the dataset of in total", nrow(df),"records \n","In case we delete all of the", sum(apply(df,1,anyNA)),"records with missing values then we are actually losing around", 100*(sum(apply(df,1,anyNA))/nrow(df)),"% of the total dataset.") 
```
# Data Preparation 

## Address the Null Value Problem

### Approach - I Deletion of All Null Values

```{r}
df.omit <- na.omit(df)
pacman::p_load(psych,DT)
headTail(df.omit, 10, 10) %>% datatable( rownames = FALSE, filter="top", options = list(pageLength = 21, scrollX=T))
cat(nrow(df.omit),ncol(df.omit))
write.csv(df.omit,file="df.omit.csv")
```




### Checking For Statistical Significance Difference Pre-Post Deletion of NULL Values     
#### Welch T-Test for Numeric Variables     

```{r "stat sig of omitting NAs in numeric variables"}
# Welch T-Test
# numeric variables names
nvar_clean <- colnames(df.omit)[c(2,22:33)]

# test difference in means
mean_tt_omit <- function(a) {
  col_t_welch(df[a], df.omit[a])
}

# create means summary table
ar_omit <- array(0, dim=c(13,17)) # create empty array 13 rows, 18 columns
ar_omit <- as.data.frame(ar_omit)     # convert to dataframe


for (i in c(2,22:33)){
  ar_omit[i,1:17] <- mean_tt_omit(i)  # add results of welch t-test
  rownames(ar_omit)[i] <- colnames(df.omit)[i]  # add variable name
}

# change column names
colnames(ar_omit)[c(1:2, 4:6, 12, 13:14)] <- c("original n", "omit NAs n", "original mean", "omit NAs mean", "mean_diff", "p-value", "lower-CI", "upper-CI")  

# print table
ar_omit[nvar_clean, c(1:2, 4:6, 12, 13:14)] %>%
  datatable(caption="Summary table of difference in means between original and cleaned dataset", rownames=TRUE, options=list(pageLength=13,scrollX=T)) %>%
  formatRound(c(3:5, 7:8), digits=2) %>%
  formatRound(6, digits=5)
```

#### Chi-squared test for categorical variables    
```{r "stat sig of removing NAs in cat variables", echo=TRUE, message=FALSE, warning=FALSE}
fvar_clean <- c(3,5,10:14,17:18,20:21)
chi_test <- function(a){
  chisq.test(table(df[,a]), p=table(df.omit[,a])/nrow(df.omit))
}
# create summary table
ar <- array(0, dim=c(11,9)) # create empty array 14 rows, 9 columns
ar <- as.data.frame(ar)     # convert to dataframe
for (i in fvar_clean){
  ar[i,1:9] <- chi_test(i)  # add results of chi-square test
  rownames(ar)[i] <- colnames(df)[i]  # add variable name
}
colnames(ar)[c(1,3)] <- c("Chi-square", "p-value")  # change column names
# print table
ar[fvar_clean, c(1,3)] %>%
  datatable(caption="Summary table of Chi-squared test on factor variables", rownames=TRUE, options=list(pageLength=14,scrollX=T)) %>%
  formatRound(columns=c(1:2), digits=6)
```
    
    
Due to large Sample size everything starts to make sense which can be seen by the p-value. Even after it shows statistically significant difference in the dataset before and after deleting null values.
<mark style ="background-color:#faed27">
We tend to ignore the statistical evidence and stick to the fact that we have quite enough sample size to represent the population as a whole.
</mark>

## Recoding and Factorizing Variables


```{r}
str(df.omit)
```

### Identifying the Variables Requires Factorization and Recoding

Factorizing 
```{r}
variables_recoded = c("wellbeing","SocialSupport","race","income","GeneralHealth","Asthma","HealthInsurance","CVD","LimitedActivity","Diabetes","employ","BMI","HeavyDrinker","CurrentSmoker","PhysicalActivity","marital")
for (i in variables_recoded){
  df.omit[,i] <- as.factor(df.omit[,i])
}
```

Checking the Status
```{r}
str(df.omit)
```

### Recoding the Variables
```{r "recoding the dataset"}
df.omit <- within(df.omit, {
  wellbeing <- Recode(wellbeing, '"1" = "Poor_Wellbeing"; "0" = "Good_Wellbeing"', as.factor=TRUE, to.value="=", interval=":", 
  separator=";")
})
df.omit <- within(df.omit, {
  CurrentSmoker <- Recode(CurrentSmoker, '"1" = "Current Smoker"; "0" = "Not a Current Smoker"; ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})
df.omit <- within(df.omit, {
  HeavyDrinker <- Recode(HeavyDrinker, '"1" = "Heavy Drinker"; "0" = "Not a Heavy Drinker"; ; ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})

df.omit <- within(df.omit, {
  HealthInsurance <- Recode(HealthInsurance , '"1" = "With Health Coverage"; "0" = "No Health Coverage"', as.factor=TRUE, to.value="=", interval=":", 
  separator=";")
})
df.omit <- within(df.omit, {
  CVD              <- Recode(CVD, '"1" = "Cardiovascular Disease"; "0" = "No Cardiovascular Disease"; ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})
df.omit <- within(df.omit, {
  Diabetes        <- Recode(Diabetes, '"1" = "Diabetic"; "0" = "Non Diabetic"; ; ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})

df.omit <- within(df.omit, {
  LimitedActivity <- Recode(LimitedActivity , '"1" = "Limited"; "0" = "Not Limited"; ; ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})

df.omit <- within(df.omit, {
  PhysicalActivity <- Recode(PhysicalActivity , '"1" = "Physically Active"; "0" = "Not Physically Active"; ; ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})

df.omit <- within(df.omit, {
  employ <- Recode(employ , '"1" = "Waged Employement"; "2" = "Self-Employed";"3" = "Unemployed for more than 1 yr" ;"4" = "Unemployed for less than 1 yr";"5" = "Homemaker";"6" = "Student";"7" = "Retired";"8" = "Unable to work" ;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})

df.omit <- within(df.omit, {
  BMI <- Recode(BMI , '"1" = "Healthy weight"; "2" = "Overweight";"3" = "Obese" ;;;', as.factor=TRUE, to.value="=", 
  interval=":", separator=";")
})

df.omit$income <- recode_factor(df.omit$income, 
                                       "1" = "less than 15000", 
                                       "2" = "[15000-25000)", 
                                       "3" = "[25000-35000)",
                                       "4" = "[35000-50000)", 
                                       "5" = "50000 or more")

df.omit$Asthma <- recode_factor(df.omit$Asthma, '0' = "No Asthma", '1' = "Asthma")

df.omit$SocialSupport <- recode_factor(df.omit$SocialSupport, '1' = "Never", '2' = " Rarely", '3' = " Sometimes", '4' = "Usually", '5' = "Always")

df.omit$race <- recode_factor(df.omit$race, '0' = "Other races", '1' = "White")

df.omit$GeneralHealth <- recode_factor(df.omit$GeneralHealth, '1' = "Excellent",
                                      '2' = "Very good",
                                      '3' = "Good",
                                      '4' = "Fair",
                                      '5' = "Poor")

df.omit$marital <- recode_factor(df.omit$marital, '0' = "Not married", '1' = "Married")

```

### Saving the Furbished File

```{r}
write.csv(df.omit,"Final_Furbished.csv",row.names = FALSE)
```



# Descriptive Analytics


## Access the data from the furbished file

```{r}
df_final = read.csv("Final_Furbished.csv")
```

```{r}
variables_recoded = c("wellbeing","SocialSupport","race","income","GeneralHealth","Asthma","HealthInsurance","CVD","LimitedActivity","Diabetes","employ","BMI","HeavyDrinker","CurrentSmoker","PhysicalActivity","marital")
for (i in variables_recoded){
  df_final[,i] <- as.factor(df_final[,i])
}
```

```{r}
summary(df_final)
```
```{r "general statistics with describe function"}
psych::describe(df_final, skew=FALSE, ranges=TRUE, quant=NULL, IQR=FALSE) %>%
  datatable(rownames=TRUE,
            options=list(pageLength=10,scrollX=T)) %>%
  formatRound(c(3:4,8), 2)
```

## Graph Styling    
```{r}
my_colors <- c("#25ADB4","#777777")
my_colors2 <- c("#67d1d3","#777777")
mycolors2 <- c("#434343","#44c5c8","#67d1d3","#8ddcde","#baeaea")
my_color_palette <- c("#FF5656", "#1A78E0")
```

## Checking distribution of categorical variables       
### Wellbeing   
```{r}
df_final %>%
ggplot(aes(x = wellbeing, fill = wellbeing)) + geom_bar(aes(y = after_stat(count)/sum(after_stat(count)))) + labs(title = "Wellbeing Distribution") + xlab("Wellbeing") + ylab("Percentage") 
```
```{r}
# add labels
df_final %>%
  ggplot(aes(x = wellbeing, fill = wellbeing)) +
  geom_bar() + 
  stat_count(aes(label = paste( round(prop.table(..count..), digits=3) * 100, "%", sep = "")),
             vjust = -1, geom = "text", position = "identity", color ="black", size=5) + 
  labs(title = "Wellbeing Distribution") + 
  ylim(0,300000) +
  xlab("Wellbeing") + 
  ylab("Number of Individuals") + 
  theme_bw() +
  theme(legend.position = "none") +
  scale_fill_manual(values=my_colors2)
```
### Age    
```{r}
df_final$Age_group <- ifelse(df_final$age < 25, "Age 18 to 24",ifelse(df_final$age < 35, "Age 25 to 34",ifelse(df_final$age < 45, "Age 35 to 44", ifelse(df_final$age < 55, "Age 44 to 54",ifelse(df_final$age < 65, "Age 55 to 64", "Age 65 or older")))))
df_final %>%
ggplot(aes(x = reorder(Age_group, Age_group, length, decreasing = FALSE), fill = Age_group, angle = 45)) +
geom_bar(aes(y = (..count..)/sum(..count..))) + labs(title = "Age Group Distribution") + xlab("Age group") + ylab("Percentage") + theme(legend.position = "none",axis.text.x = element_text(angle = 45))
```

```{r}
# add labels
df_final %>%
  ggplot(aes(x = reorder(Age_group, Age_group, length, decreasing = FALSE), fill = Age_group)) +
  geom_bar() + 
  stat_count(aes(label = paste( round(prop.table(..count..), digits=3) * 100, "%", sep = "")),
             vjust = -1, geom = "text", position = "identity", color ="black", size=5) + 
  ylim(0,90000) +
  labs(title = "Age Group Distribution") + 
  xlab("Age group") + 
  ylab("Number of Individuals") + 
  theme_bw() +
  theme(legend.position = "none")

```
### Social Support    
```{r}
df_final %>%
ggplot(aes(x = SocialSupport, fill = SocialSupport)) + geom_bar() + geom_bar(aes(y = (..count..)/sum(..count..))) + labs(title = "Social Support Distribution") + xlab("Social Support") + ylab("Percentage")
```
### Income    
```{r}
df_final %>%
ggplot(aes(x = income, fill = income)) + geom_bar(aes(y = (..count..)/sum(..count..))) + labs(title = "Income Distribution") + xlab("Income") + ylab("Percentage") + theme(legend.position = "none",axis.text.x = element_text(angle = 45))
```
### Employment Status   
```{r, fig.width=7, fig.height=5}
# employment status
library(scales)
df_final %>%
  ggplot(aes(x = reorder(employ, employ, length, decreasing = FALSE), fill = employ)) +
  geom_bar() + 
  stat_count(aes(label = paste( round(prop.table(..count..), digits=3) * 100, "%", sep = "")),
             vjust = -1, geom = "text", position = "identity", color ="black", size=5) + 
  ylim(0,150000) +
  labs(title = "Employment Status Distribution") + 
  xlab("Employment Status") + 
  ylab("Number of Individuals") + 
  theme_bw() +
  scale_x_discrete(labels = wrap_format(10)) +
  theme(legend.position = "none")
```

### General Health    
```{r}
df_final %>%
ggplot(aes(x = GeneralHealth, fill = GeneralHealth)) + geom_bar(aes(y = (..count..)/sum(..count..))) + labs(title = "General Health Distribution") + xlab("General Health Status") + ylab("Percentage") + theme(legend.position = "none",axis.text.x = element_text(angle = 45))
```
### Asthma   
```{r}
df_final %>%
ggplot(aes(x = Asthma, fill = Asthma)) + geom_bar(aes(y = (..count..)/sum(..count..))) + labs(title = "Asthma Distribution") + xlab("Asthma") + ylab("Percentage") 
```
### Race     
```{r}
df_final %>%
ggplot(aes(x = race, fill = race)) + geom_bar(aes(y = (..count..)/sum(..count..))) + labs(title = "Race Distribution") + xlab("Race") + ylab("Percentage") 
```
```{r}
race_bar <- df_final %>%
  ggplot(aes(x = race, fill = race)) + 
  geom_bar() +
  stat_count(aes(label = paste( round(prop.table(..count..), digits=3) * 100, "%", sep = "")), vjust = -1, geom = "text", position = "identity", color ="black", size=5) + 
  ylim(0,260000) + 
  labs(title = "Race Distribution") + 
  xlab("Race") + 
  ylab("Percentage") + 
  theme_bw() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette="Dark2")

race_bar
```
### Marital Status Distribution   
```{r}
# bar chart
df_final %>%
  ggplot(aes(x = marital, fill = marital)) + 
  geom_bar() +
  stat_count(aes(label = paste( round(prop.table(..count..), digits=3) * 100, "%", sep = "")), vjust = -1, geom = "text", position = "identity", color ="black", size=5) + 
  ylim(0,200000) + 
  labs(title = "Marital Status Distribution") + 
  xlab("Marital Status") + 
  ylab("Percentage") + 
  theme_bw() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set1")
```

## Bivariate analysis      
### Age and Race   
```{r}
# age and race
age_race_plot <- df.omit %>% 
  ggdensity(  x = "age" ,
     add = "mean", rug = FALSE,
     color = "race", fill = "race", palette = "Dark2", alpha=0.25) +
  ggtitle("Density Graph of Age by Race") +
  theme_bw() +
  theme(legend.position="right")

age_race_plot
```
```{r}
p_ra <- df_final %>%
  ggplot(aes(x = Age_group, fill = race)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") + 
  labs(title = "Age Group and Race Distribution") + 
  theme_bw() +
  theme(legend.position="right") +
  scale_fill_brewer(palette="Dark2")
p_ra
```
 
### Wellbeing and Race   
```{r}
p3 <- df_final %>%
  ggplot(aes(x = race, fill = wellbeing)) + geom_bar(position = "fill") + ylab("proportion") + labs(title = "Wellbeing status on different races")
p3
```

```{r}
table(df_final$wellbeing, df_final$race)
```


```{r}
rx.p1 <- df_final %>% 
  ggplot(aes(x = race, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

rx.p2 <- df_final %>% 
  ggplot(aes(x = race, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

library(patchwork)
rx.p1 + rx.p2
```
<br><mark style ="background-color:#faed27">
There seems to be minimal visual difference in the percentages of the Poor and Good Wellbeing for Race Non white and Hispanic and Race White and Hispanic </mark>      
     
     
     
### Wellbeing and Social Support
```{r}

p1a <- df_final %>%
 ggplot(aes(x = SocialSupport, fill = wellbeing)) + geom_bar(position = "fill") + ylab("proportion") + labs(title = "Wellbeing status on different social support level")
p1a
```
```{r}
p1a2 <- df_final %>%
 ggplot(aes(x = SocialSupport, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") + 
  labs(title = "Wellbeing status on different social support level") +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(
    legend.position="bottom",
    axis.text.x = element_text(size=8, face="bold"),)
p1a2
```
#### Wellbeing, Social Support, and Race
```{r}
tab_xtab(df_final$SocialSupport, df_final$wellbeing, show.cell.prc=TRUE)
```
```{r, fig.height=5, fig.width=8}
p1a2 + facet_wrap(~race)
```

#### Wellbeing, Social Support, and Age    
```{r}
p1a2 + facet_wrap(~Age_group)
```

### Wellbeing and Income
```{r}
p2 <- df_final %>%
  ggplot(aes(x = income, fill = wellbeing)) + geom_bar(position = "fill") + ylab("proportion") + theme(axis.text.x = element_text(angle = 30)) + labs(title = "Wellbeing status on different income status")
p2
```
#### Bin Median HouseholdIncome (county)    
```{r}
# bin mean household income to match individual income bins
df_final <- df_final %>%
  mutate(HouseholdIncome.bin = cut(HouseholdIncome, breaks=c(0, 24999, 34999, 49999, 119525)))

df_final$HouseholdIncome.bin <- recode_factor(df_final$HouseholdIncome.bin, "(0,2.5e+04]" = "less than 25000", "(2.5e+04,3.5e+04]" = "[25000,35000)", "(3.5e+04,5e+04]" = "[35000,50000)","(5e+04,1.2e+05]" = "50000 or more")
frq(df.omit$HouseholdIncome.bin)
```
```{r}
tab_xtab(df_final$HouseholdIncome.bin, df_final$wellbeing, show.col.prc = TRUE, show.exp = TRUE)  
```


```{r, fig.height=6, fig.width=8}
# compare againt individual income
df_final %>% 
  group_by(HouseholdIncome.bin) %>%
  ggplot(aes(x = income, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  ggtitle("Wellbeing status by income level, grouped by county median household income") +
  facet_wrap(~HouseholdIncome.bin, ncol=4) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) +
  scale_fill_manual(values=my_colors2)
```

#### Wellbeing, Income, Age   
```{r, fig.height=4, fig.width=6}
# income and wellbeing
df_final %>% 
  ggplot(aes(x = income, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  ggtitle("Wellbeing status on different income levels, grouped by race") +
  facet_wrap(~race) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) +
  theme(legend.position="bottom") +
  scale_fill_manual(values=my_colors2)
```

### Wellbeing and Asthma    
```{r}
p4 <- df_final %>%
  ggplot(aes(x = Asthma, fill = wellbeing)) + geom_bar(position = "fill") + ylab("proportion") + labs(title = "Wellbeing status between people having or not Asthma")
p4
```

### Wellbeing and Age    
```{r}
p5 <- df_final %>%
  ggplot(aes(x = Age_group, fill = wellbeing)) + geom_bar(position = "fill") + ylab("proportion") + labs(title = "Wellbeing status on different age group") + theme(axis.text.x = element_text(angle = 0)) + theme_bw() + scale_fill_manual(values=my_colors2)
p5
```

### Wellbeing and General Health   
```{r}
p6 <- df_final %>%
  ggplot(aes(x = GeneralHealth, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") + 
  labs(title = "Wellbeing status on different general health status") +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(
    legend.position="bottom",
    axis.text.x = element_text(size=12, face="bold"),)
p6 
```
#### Wellbeing, General Health, and Race   
```{r}
tab_xtab(df_final$GeneralHealth, df_final$wellbeing, show.cell.prc=TRUE)
```
```{r}
p6 + facet_wrap(~race)
```

### Wellbeing and CVD   
```{r}
p8 <- df_final %>%
  ggplot(aes(x = CVD, fill = wellbeing)) + geom_bar(position = "fill") + ylab("proportion") + labs(title = "Wellbeing status on patient with and without CVD")
p8 
```
    

```{r}
table(df_final$wellbeing, df_final$CVD)
```


```{r fig.width=8}
rx.p1 <- df_final %>% 
  ggplot(aes(x = CVD, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

rx.p2 <- df_final %>% 
  ggplot(aes(x = CVD, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

library(patchwork)
rx.p1 + rx.p2
```    
<mark style ="background-color:#faed27">
There seems to be visual difference in the percentages of the Poor and Good Wellbeing for poeple with and without CVD </mark>        


### Wellbeing and Physical Activity

```{r}
table(df_final$wellbeing, df_final$HealthInsurance)
```


```{r}
x1 = df_final %>% 
  ggplot(aes(x = PhysicalActivity , fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")


x2 = df_final %>% 
  ggplot(aes(x = PhysicalActivity , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  xlab("Physical Activity in the Last 30 Days") +
  ggtitle("Physical Activity or Exercise in the Last 30 Days") +
  scale_x_discrete(labels = wrap_format(10)) +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none",
        axis.text.x = element_text( size=14, face="bold"))

x1 + x2
```

### Wellbeing and Smoking Status
```{r}
smoke.p2 <- df_final %>% 
  ggplot(aes(x = CurrentSmoker, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  xlab("Current Smoking Status") +
  ggtitle("Current Smoking Status") +
  scale_x_discrete(labels = wrap_format(10)) +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none",
        axis.text.x = element_text( size=14, face="bold"))

library(patchwork)
smoke.p2
```
    
 
 
### Wellbeing and LimitedActivity

```{r}
table(df_final$LimitedActivity, df_final$wellbeing)
```

```{r}
 df_final %>% 
  ggplot(aes(x = LimitedActivity , fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")


```

```{r}
df_final %>% 
  ggplot(aes(x = LimitedActivity , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")
```
<mark style ="background-color:#faed27">
It could be confirmed visually that with Low Physical Activitys <b> there is a significant increase in proportion of the Poor Wellbeing of individuals</b>
</mark>
     
```{r}
limact_p <- df_final %>% 
  ggplot(aes(x = LimitedActivity , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  xlab("Limited activity due to health problems") +
  ggtitle("Limited Activity due to Health Problems") +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none")

limact_p
```

### Wellbeing and Diabetes

```{r}
table(df_final$wellbeing, df_final$Diabetes)
```


```{r}
rx.p1 <- df_final %>% 
  ggplot(aes(x = Diabetes, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

rx.p2 <- df_final %>% 
  ggplot(aes(x = Diabetes, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

library(patchwork)
rx.p1 + rx.p2
```
<br><mark style ="background-color:#faed27">
There seems to be a visual difference in the percentages of the Poor and Good Wellbeing between Diabetic and Non Diabetic individuals.</mark>
     
### Wellbeing and Employment

```{r}
table(df_final$wellbeing, df_final$employ)
```


```{r fig.width= 8}
 df_final %>% 
  ggplot(aes(x = employ, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

```

```{r fig.width=10}
df_final %>% 
  ggplot(aes(x = employ, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  xlab("employment status") +
  ylab("proportion") +
  ggtitle("Wellbeing status by employment status") +
  theme_bw() +
  scale_x_discrete(labels = wrap_format(10)) +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "top")
```

#### Wellbeing, age, employments status
```{r}
p_empa <- df_final %>%
  ggplot(aes(x = employ, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  xlab("employment status") +
  ylab("proportion") +
  ggtitle("Wellbeing status by employment status, group by age") +
  facet_wrap(~Age_group, ncol=2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "top")
p_empa
```

<br><mark style ="background-color:#faed27">
--> There seems to be minimal visual difference in the percentages of the Poor and Good Wellbeing for Homemaker, Retired and Waged Employment </mark><br>
--> There is relatively higher proportions of Poor Wellbeing in students than the prior-mentioned employment groups.<br>
--> <b>Individuals who are unable to work or are unemployed (either more than a year or less than a year) have significantly higher proportions of Poor Wellbeing than any other employment status groups.</b>

### Wellbeing and Health care access (insurance)   
```{r}
rx.p1 <- df_final %>% 
  ggplot(aes(x = HealthInsurance, fill = wellbeing)) + 
  geom_bar() +  
  ylab("number of individuals") +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none") 

rx.p2 <- df_final %>% 
  ggplot(aes(x = HealthInsurance, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  theme_bw() +
  scale_fill_manual(values=my_colors2)

library(patchwork)
rx.p1 + rx.p2 + ggtitle("Wellbeing status by health insurance")
```

### Wellbeing and BMI     

```{r}
table(df_final$wellbeing, df_final$BMI)
```


```{r fig.width= 8}
 df_final %>% 
  ggplot(aes(x = BMI, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

```

```{r fig.width=10}
df_final %>% 
  ggplot(aes(x = BMI, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")
```


<br><mark style ="background-color:#faed27">
Individuals with higher BMI tend to have slightly higher proportions of "POOR" wellbeing. </mark>


### Wellbeing and Poor Sleep Days    

```{r}
table(df_final$PoorSleepDays, df_final$wellbeing)
```

```{r}
 df_final %>% 
  ggplot(aes(x = PoorSleepDays , fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")


```

```{r}
df_final %>% 
  ggplot(aes(x = PoorSleepDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")
```
<mark style ="background-color:#faed27">
It could be seen visually that with increment in the Poor Sleep days <b> there is a significant increase in the Poor Wellbeing of indivduals</b>. 
</mark>

### Wellbeing and PhysicalActivity   

```{r}
table(df_final$PhysicalActivity, df_final$wellbeing)
```

```{r}
x1 = df_final %>% 
  ggplot(aes(x = PhysicalActivity , fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")


x2 =df_final %>% 
  ggplot(aes(x = PhysicalActivity , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")
library(patchwork)
x1+x2
```
<mark style ="background-color:#faed27">
It could be confirmed visually that with Low Physical Activitys <b> there is a significant increase in proportion of the Poor Wellbeing of individuals</b>
</mark>


### Wellbeing and Smoking Status

```{r}
table(df_final$wellbeing, df_final$CurrentSmoker)
```


```{r}
rx.p1 <- df_final %>% 
  ggplot(aes(x = CurrentSmoker, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

rx.p2 <- df_final %>% 
  ggplot(aes(x = CurrentSmoker, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

library(patchwork)
rx.p1 + rx.p2
```
<mark style ="background-color:#faed27">
From the Visual Evidence, it could be said that the Smoking Status affect the Wellbeing of an individual. It could interpreted from the graph that more number of current smokers possess poor wellbeing as compared to those who are not a current smoker.
</mark>


### Wellbeing and Heavy Drinking Habits

```{r}
table(df_final$wellbeing, df_final$HeavyDrinker)
```


```{r}
rx.p1 <- df_final %>% 
  ggplot(aes(x = HeavyDrinker, fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")

rx.p2 <- df_final %>% 
  ggplot(aes(x = HeavyDrinker, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

library(patchwork)
rx.p1 + rx.p2
```
<mark style ="background-color:#faed27">
There seems to be minimal visual difference in the percentages of the Poor and Good Wellbeing for Heavy Drinker and not a Heavy Drinker. </mark>


### Wellbeing and Poor Health Days      
#### Poor Physical Health Days

```{r}
table(df_final$PoorPhysicalHealthDays, df_final$wellbeing)
```

```{r}
 df_final %>% 
  ggplot(aes(x = PoorPhysicalHealthDays , fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")


```

```{r}
df_final %>% 
  ggplot(aes(x = PoorPhysicalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")
```
<mark style ="background-color:#faed27">
It could be seen visually that with increment in the Poor Physical Health days <b> there is a significant increase in the Poor Wellbeing of indivduals</b>
</mark>

#### Poor Mental Health Days

```{r}
table(df_final$PoorMentalHealthDays, df_final$wellbeing)
```

```{r}
 df_final %>% 
  ggplot(aes(x = PoorMentalHealthDays , fill = wellbeing)) + 
  geom_bar() + 
  theme(legend.position = "none")


```

```{r}
df_final %>% 
  ggplot(aes(x = PoorMentalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")
```
<mark style ="background-color:#faed27">
It could be seen visually that with increment in the Poor Mental Health days <b> there is a significant increase in the Poor Wellbeing of indivduals</b>. 
</mark>

#### Wellbeing, poor mental health, drinking   
```{r}
df_final %>% 
  ggplot(aes(x = PoorMentalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  facet_wrap(~HeavyDrinker) +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "bottom")
  
```

#### Comparing the increment of Poor Wellbeing in Poor Mental and Poor Physical Wellbeing    

```{r fig.width=10}
r1 = df_final %>% 
  ggplot(aes(x = PoorPhysicalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

r2 = df_final %>% 
  ggplot(aes(x = PoorMentalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion")

library(patchwork)
r1+r2
```
#### Comparing Poor Mental, Physical and Poor Sleep Days       
```{r}
poor_mh_p <- df_final %>% 
  ggplot(aes(x = PoorMentalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  xlab("Number of poor mental health days") +
  ggtitle("Poor Mental Health Days") +
  scale_x_discrete(labels = wrap_format(10)) +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none")

poor_ph_p <- df_final %>% 
  ggplot(aes(x = PoorPhysicalHealthDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  xlab("Number of poor physical health days") +
  ggtitle("Poor Physical Health Days") +
  scale_x_discrete(labels = wrap_format(10)) +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none")

poor_s_p <- df_final %>% 
  ggplot(aes(x = PoorSleepDays , fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  xlab("Number of poor sleep days") +
  scale_x_discrete(labels = wrap_format(10)) +
  ggtitle("Poor Sleep Days") +
  theme_bw() +
  scale_fill_manual(values=my_colors2) +
  theme(legend.position = "none")  +
  theme(legend.position = "right")

poor_mh_p + poor_ph_p + poor_s_p
```

It is visually prominent that in both cases whenevr there is increase in the number of Poor Physical Health days or Poor Mental Health Days there seems to be almost linear increase in the Poor Wellbeing of the individuals <br>

<b> This also coduld be deduced from the graph that there is a clear association between Poor Health Days (Mental or Physical) and the Wellbeing of an indivdual. </b>

<br><br>
The more interesting part to notice in here is that<mark style ="background-color:#faed27">
The increment in proportions of "Poor Wellbeing" in the Poor Mental Health days is quite more <b> there is a significant increase in the Poor Wellbeing of indivduals</b>. 
</mark>



## Inspecting Presence of potential correlations   
### Poor Physical and Poor Mental Health days

```{r "Poor mental and physical health days scatter plot by wellbeing"}
df_final %>% ggplot(aes(x=PoorPhysicalHealthDays,y=PoorMentalHealthDays,colour =wellbeing)) + geom_point() + geom_abline(intercept=30, slope=-1)
```

Visual Representation rejects my hypothesis that there is any correlation between the Poor Physical and Poor Mental heath days.

<br><br>
1. No presence of correlation between the Poor Mental and Poor Health Days<br>
2. If the Graph is colored based on the Well being of an individual some thing very important starts to pop up : <br>
<b> We can visually bifurcate the presence of "Poor Wellbeing and Good Wellbeing" with a line y=-x where the upper half denotes More Poor Physical and More Poor Mental Health days where individauls have Poor Wellbeing</b> <br>
3. The sparse distribution of points in the upper half of the line signifies relatively lesser records of individuals who have higher poor mental or physical health days.


### Some College Rate and Some High School Rate in the presence of Wellbeing

```{r "education attainment scatter plot by wellbeing"}
df_final %>% ggplot(aes(x=SomeCollegeRate,y=HighSchoolRate,colour = wellbeing)) + geom_point() + facet_grid(~wellbeing)
```

There is a clear presence of correlation between the two variables. That indicates that with increase in the College Rate there is parallel increment in School Rate specific to the county. 

It is also evident that the distribution more or less remains the same for both wellbeings.

We could reject the possibility of interaction on wellbeing on High School and Some College Rates


### PM2.5 and Population Density in the presence of Wellbeing

```{r "PM2.5 and pop dens scatter plot by wellbeing"}
df_final %>% ggplot(aes(x=PM2.5,y=PopulationDensity,colour = wellbeing)) + geom_point() + facet_wrap(~wellbeing) +ylim(0,15000)
```

There is a clear presence of correlation between the two variables. That indicates with increase in the Population Density there is increment in the PM2.5 specific to the county. 

It is also evident that the distribution more or less remains the same for both wellbeings.

We could reject the possibility of interaction on wellbeing on High School and Some College Rates



```{r "education attainment by wellbeing and heavy drinkers scatter plots"}
df_final %>% ggplot(aes(x=SomeCollegeRate,y=HighSchoolRate,colour = wellbeing)) + geom_point() + facet_grid(HeavyDrinker~wellbeing)

```

## Correlation between All Numeric Variables   
```{r, fig.height=10, fig.width=10}
# library(corrplot)
# library(sjPlot)
rr_county <- df_final[,c(2,22:33)]
rr_cm <- as.matrix(rr_county)

corr_m <- cor(rr_cm, use="pairwise.complete.obs")
```

### Correlation Table
```{r, fig.height=10, fig.width=10}
# correlation matrix table
tab_corr(rr_county,
         na.deletion="pairwise",
         corr.method="pearson",
         title="Correlations with pair-wise NA deletion",
         show.p=TRUE)
```

### Correlation Visualization
```{r, fig.height=10, fig.width=10}
# correlogram
testRes <- cor.mtest(rr_cm, conf.level = 0.95)
corrplot.mixed(corr_m,
               upper = "ellipse",
               p.mat = testRes$p,
               title="Correlation Matrix of Variables of Interest"
               )
```
### Highly Correlated Groups
```{r "pairs panels for highly correlated county variables"}
pairs.panels(df_final[, c(23:24,26,29:31)], scale = TRUE, ellipses = FALSE, pch = ".", lm = TRUE, rug = FALSE, stars = TRUE)
```


## Association between Wellbeing and County Variables    
```{r, fig.height=10, fig.width=8}
# density plots
premort_wb_plot <- df_final %>% 
  ggdensity(  x = "PrematureMortality" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25)

hincome_wb_plot <- df_final %>% 
  ggdensity(  x = "HouseholdIncome" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25) + 
  theme(legend.position="none")

park_wb_plot <- df_final %>% 
  ggdensity(  x = "ParkAccess" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25) +
  theme(legend.position="none")

crime_wb_plot <- df_final %>% 
  ggdensity(  x = "CrimeRate" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25) +
  theme(legend.position="none")

unemp_wb_plot <- df_final %>% 
  ggdensity(  x = "UnemploymentRate" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25)

water_wb_plot <- df_final %>% 
  ggdensity(  x = "WaterSafety" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25) +
  theme(legend.position="none")

rec_wb_plot <- df_final %>% 
  ggdensity(  x = "AccessToRecFacility" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25) +
  theme(legend.position="none")

fastfood_wb_plot <- df_final %>% 
  ggdensity(  x = "FastFoodPercentage" ,
     add = "mean", rug = FALSE,
     color = "wellbeing", fill = "wellbeing", palette=my_colors, alpha=0.25) +
  theme(legend.position="none")
```

  
### Premature Mortality Plots   
```{r}
# premature mortality
premort_wb_plot + ggtitle("Density plot of county premature mortality by wellbeing") + theme(legend.position="right") + theme_bw()
```
```{r "premature mortality violin plot"}
df_final %>%
  ggplot(aes(x=wellbeing, y=PrematureMortality, fill=wellbeing)) +
  geom_violin(alpha=0.75) +
  theme_bw() +
  ggtitle("Violin Plot of Premature Mortality by Wellbeing Status") +
  scale_fill_manual(values=my_colors2)
```

```{r}
# county level factors won't changed based on wellbeing, which is individual
df_final %>%
  ggplot(aes(x=HouseholdIncome, y=PrematureMortality, group=wellbeing, color=wellbeing)) +
  geom_point(shape=1,alpha=0.5) +
  theme_bw() +
  stat_smooth(method="lm", formula=y~x, geom="smooth", se=TRUE) +
  ggtitle("Scatter Plot of County-Level Mean Household Income and\nNumber of Premature Deaths per 100,000") + 
  facet_grid(~wellbeing)

df_final %>%
  ggplot(aes(x=HouseholdIncome, y=PrematureMortality, group=wellbeing, color=wellbeing)) +
  geom_point(alpha=0) +
  theme_bw() +
  stat_smooth(method="lm", formula=y~x, geom="smooth", se=TRUE) +
  ggtitle("Trendlines of County-Level Mean Household Income and\nNumber of Premature Deaths per 100,000") 
```
    
Counties with higher mean household incomes tended to have lower premature mortality rates. This trend appears consistent across individuals who reported having good wellbeing and those that reported having poor wellbeing. 

```{r}
df_final %>%
  ggplot(aes(x=income, y=PrematureMortality, group=income, color=income)) +
  geom_jitter(shape=1,alpha=0.5) +
  theme_bw() +
  ggtitle("Jitter Plot of Individual Income Group and\nNumber of Premature Deaths per 100,000") + 
  facet_grid(~wellbeing)

df_final %>%
  ggplot(aes(x=income, y=PrematureMortality, group=income, color=income)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Box Plot of Individual Income Group and\nNumber of Premature Deaths per 100,000") + 
  facet_grid(~wellbeing)
```
   
   
### Household Income Plots   
```{r}
hincome_wb_plot + ggtitle("Density plot of county household income by wellbeing") + theme(legend.position="right") + theme_bw()
```
        
```{r}
df_final %>%
  ggplot(aes(x=HouseholdIncome, group=wellbeing, fill=wellbeing)) +
  geom_density() +
  facet_wrap(~wellbeing, ncol=1) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values=my_colors2)
```
 
```{r}
df_final %>%
  ggplot(aes(x=income, y=HouseholdIncome, group=income, color=income)) +
  geom_jitter(shape=1,alpha=0.5) +
  theme_bw() +
  ggtitle("Jitter Plot of County-Level Mean Household Income and\nIndividual Income Group") + 
  facet_grid(~wellbeing)

df_final %>%
  ggplot(aes(x=income, y=HouseholdIncome, group=income, color=income)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Box Plot of County-Level Mean Household Income and\nInividual Income Group") + 
  facet_grid(~wellbeing)
```
     
Among those with good wellbeing, there appear to be more indviduals living in counties with high household incomes.  

#### Bin HouseholdIncome
```{r}
# bin mean household income to match individual income bins
df_final <- df_final %>%
  mutate(HouseholdIncome.bin = cut(HouseholdIncome, breaks=c(0, 24999, 34999, 49999, 119525)))

df_final$HouseholdIncome.bin <- recode_factor(df_final$HouseholdIncome.bin, "(0,2.5e+04]" = "less than 25000", "(2.5e+04,3.5e+04]" = "[25000,35000)", "(3.5e+04,5e+04]" = "[35000,50000)","(5e+04,1.2e+05]" = "50000 or more")
frq(df_final$HouseholdIncome.bin)
```
```{r}
# create equal sized bins
library(funModeling)
df_final$HouseholdIncome.bin.equal <- equal_freq(var=df_final$HouseholdIncome, n_bins=5)
frq(df_final$HouseholdIncome.bin.equal)
```

```{r}
tab_xtab(df_final$HouseholdIncome.bin, df_final$wellbeing, show.col.prc = TRUE, show.exp = TRUE)  
```


```{r, fig.height=6, fig.width=8}
# compare againt individual income
df_final %>% 
  group_by(HouseholdIncome.bin) %>%
  ggplot(aes(x = income, fill = wellbeing)) + 
  geom_bar(position = "fill") + 
  ylab("proportion") +
  facet_wrap(~HouseholdIncome.bin) +
  theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1))
```
     
     
### Park Access Plots   
```{r}
park_wb_plot + ggtitle("Density plot of county park access by wellbeing") + theme(legend.position="right") + theme_bw()
```
    
    
### Crime Rate Plots   
```{r}
crime_wb_plot + ggtitle("Density plot of county crime rate by wellbeing") + theme(legend.position="right") + theme_bw()
```
    
    
### Unemployment Rate Plots   
```{r}
unemp_wb_plot + ggtitle("Density plot of county unemployment rate by wellbeing") + theme(legend.position="right") + theme_bw()
```
    
    
### Water Safety Plots   
```{r}
water_wb_plot + ggtitle("Density plot of Water Safety Rate by wellbeing") + theme(legend.position="right") + theme_bw()
```
    
```{r}
waterlog_wb_plot <- df_final %>% 
  mutate(WaterSafetyLog = log(WaterSafety,10)) %>%
  filter(WaterSafetyLog >= 0) %>%
  ggdensity(  x = "WaterSafetyLog" ,
     color = "wellbeing", fill = "wellbeing", alpha=0.25) +
  theme(legend.position="right")

waterlog_wb_plot
```
    
```{r}
# box plots
df_final %>%
  ggplot(aes(x=WaterSafety, group=wellbeing, fill=wellbeing)) +
  geom_boxplot() +
  facet_wrap(~wellbeing, ncol=1) +
  theme_bw() +
  scale_fill_manual(values=my_colors2)
```
    
## Access to Recreational Facilities Plots   
```{r}
rec_wb_plot + ggtitle("Density plot of county recreational facility access by wellbeing") + theme(legend.position="right") + theme_bw()
```
    
    
## Fast Food Percentage Plots   
```{r}
fastfood_wb_plot + ggtitle("Density plot of county fast food restaurant percentage\nby wellbeing") + theme(legend.position="right") + theme_bw()
```
    
##### By BMI
```{r}
# BMI
df_final %>%
  ggplot(aes(x=FastFoodPercentage, group=BMI, fill=BMI)) +
  geom_density() +
  facet_wrap(~BMI) +
  theme_bw()
```

    
##### By CVD
```{r}
# BMI
df_final %>%
  ggplot(aes(x=FastFoodPercentage, group=CVD, fill=CVD)) +
  geom_density() +
  facet_wrap(~CVD) +
  theme_bw()
```

##### By General Health
```{r}
# BMI
df_final %>%
  ggplot(aes(x=FastFoodPercentage, group=GeneralHealth, fill=GeneralHealth)) +
  geom_density() +
  facet_wrap(~GeneralHealth) +
  theme_bw()
```

##### By Diabetes    
```{r "BMI by diabetes density plots"}
# BMI
df_final %>%
  ggplot(aes(x=FastFoodPercentage, group=Diabetes, fill=Diabetes)) +
  geom_density() +
  facet_wrap(~Diabetes) +
  theme_bw()
```

## All Plots    
```{r, fig.height=10, fig.width=8}
multiplot(premort_wb_plot, hincome_wb_plot, park_wb_plot, crime_wb_plot, unemp_wb_plot, water_wb_plot, rec_wb_plot, fastfood_wb_plot, plotlist=NULL, cols=2)
```


# Logistic Regression Model (Statistical Methods)   
## All Predictors    
```{r}
# set up variables 
dependent <- "wellbeing"
pred.all <- c("age","SocialSupport","race","income","GeneralHealth","PoorPhysicalHealthDays","PoorMentalHealthDays","Asthma","HealthInsurance","CVD","LimitedActivity","Diabetes","employ","BMI","HeavyDrinker","CurrentSmoker","PoorSleepDays","PhysicalActivity","marital","PrematureMortality","HouseholdIncome","ParkAccess","CrimeRate","UnemploymentRate","WaterSafety","HighSchoolRate","SomeCollegeRate","AccessToRecFacility","FastFoodPercentage","PM2.5","PopulationDensity")
```


```{r "log reg stat model all predictors"}
# initial model
model.all <- glm(wellbeing ~ 
                 age+
                 SocialSupport+
                 race+
                 income+
                 GeneralHealth+
                 PoorPhysicalHealthDays+
                 PoorMentalHealthDays+
                 Asthma+
                 HealthInsurance+
                 CVD+
                 LimitedActivity+
                 Diabetes+
                 employ+
                   BMI+
                  HeavyDrinker+
                  CurrentSmoker+
                  PoorSleepDays+
                  PhysicalActivity+
                  marital+
                  PrematureMortality+
                  HouseholdIncome+
                  ParkAccess+
                  CrimeRate+
                  UnemploymentRate+
                  WaterSafety+
                  HighSchoolRate+
                  SomeCollegeRate+
                  AccessToRecFacility+
                  FastFoodPercentage+
                  PM2.5+
                  PopulationDensity,
               family=binomial,
               data=df_final)

summary(model.all)
```


### Multicollinearity   
#### Correlations for all numeric predictors    
```{r, fig.height=10, fig.width=10}
# library(corrplot)
# library(sjPlot)
rr_county <- df_final[,c(2,22:33)]
rr_cm <- as.matrix(rr_county)

corr_m <- cor(rr_cm, use="pairwise.complete.obs")
```

##### Correlation Table
```{r, fig.height=10, fig.width=10}
# correlation matrix table
tab_corr(rr_county,
         na.deletion="pairwise",
         corr.method="pearson",
         title="Correlations with pair-wise NA deletion",
         show.p=TRUE)
```

##### Correlation Visualization
```{r, fig.height=10, fig.width=10}
# correlogram
testRes <- cor.mtest(rr_cm, conf.level = 0.95)
corrplot.mixed(corr_m,
               upper = "ellipse",
               p.mat = testRes$p,
               title="Correlation Matrix of Variables of Interest",
               tl.pos = "lt")
```
##### Highly Correlated Groups
```{r}
pairs.panels(df_final[, c(23:24,26,29:31)], scale = TRUE, ellipses = FALSE, pch = ".", lm = TRUE, rug = FALSE, stars = TRUE)
```

```{r}
rr_county_sig <- df_final[,c(2,22,24,25,26,27,29)]
rr_cm_sig <- as.matrix(rr_county_sig)

corr_m_sig <- cor(rr_cm_sig, use="pairwise.complete.obs")
# correlogram
testRes_sig <- cor.mtest(rr_cm_sig, conf.level = 0.95)
corrplot.mixed(corr_m_sig,
               upper = "ellipse",
               p.mat = testRes_sig$p,
               tl.pos = "lt")
```


#### VIF for all Predictors Model    
```{r}
library(car)
library(finalfit)
library(MASS)
vif_all <- vif(model.all)
vif_all <- as.data.frame(vif_all)
```

```{r}
#create horizontal bar chart to display each VIF value
vif_plot_all <- vif_all %>%
  ggplot(aes(x=rownames(vif_all), y=GVIF)) +
  geom_col(color="#434343", fill="#6BD6DB") +
  xlab("All Predictors") +
  ylab("VIF Values") +
  ggtitle("VIF Values for All Predictors") +
  theme_bw() +
  geom_hline(aes(yintercept=5),color="#434343", linetype="dashed", linewidth=0.5) +
  coord_flip()

vif_plot_all
```


### Stepwise Regression   
#### Stepwise function
```{r "stepwise regression both directions for all predictors"}
step <- stepAIC(model.all, direction="both") # Stepwise function
```
    
#### Final Stepwise model
```{r "log reg stepwise model"}
model.step <- glm(formula= df_final$wellbeing ~ . ,
             df_final[,(colnames(step$model[-1]))], family=binomial(logit))

summary(model.step)
```


## Remove statistically insignificant predictors
```{r}
# setup variable 
pred.m1 <- c("age","SocialSupport","race","income","GeneralHealth","PoorPhysicalHealthDays","PoorMentalHealthDays","HealthInsurance","LimitedActivity","employ","BMI","HeavyDrinker","CurrentSmoker","PoorSleepDays","PhysicalActivity","marital","PrematureMortality","ParkAccess","CrimeRate","WaterSafety","SomeCollegeRate")
```


```{r "reduced log reg statistical model"}
# model with reduced predictors
model.1 <- glm(wellbeing ~ 
                 age+
                 SocialSupport+
                 race+
                 income+
                 GeneralHealth+
                 PoorPhysicalHealthDays+
                 PoorMentalHealthDays+
                 HealthInsurance+
                 LimitedActivity+
                 employ+
                 BMI+
                  HeavyDrinker+
                  CurrentSmoker+
                  PoorSleepDays+
                 PhysicalActivity+
                  marital+
                  PrematureMortality+
                  ParkAccess+
                  CrimeRate+
                  WaterSafety+
                  SomeCollegeRate,
               family=binomial,
               data=df_final)

summary(model.1)
```
       
       
### Multicollinearity    
#### Correlations for all numeric predictors   
```{r, fig.height=10, fig.width=10}
# library(corrplot)
# library(sjPlot)
rr_county.m1 <- df_final[,c(2,22, 24:27,29)]
rr_cm.m1 <- as.matrix(rr_county.m1)

corr_m1 <- cor(rr_cm.m1, use="pairwise.complete.obs")
```

##### Correlation Visualization
```{r, fig.height=10, fig.width=10}
# correlogram
testRes.m1 <- cor.mtest(rr_cm.m1, conf.level = 0.95)
corrplot.mixed(corr_m1,
               upper = "ellipse",
               p.mat = testRes.m1$p,
               title="Correlation Matrix of Variables of Interest")
```
    
    
#### VIF for Reduced Predictors Model    
```{r}
vif_1 <- vif(model.1)
vif_1 <- as.data.frame(vif_1)
```

```{r}
#create horizontal bar chart to display each VIF value
vif_plot_1 <- vif_1 %>%
  ggplot(aes(x=rownames(vif_1), y=GVIF)) +
  geom_col(color="#434343", fill="#FFB87B") +
  xlab("Statistically Significant Predictors") +
  ylab("VIF Values") +
  ggtitle("VIF Values for Reduced Model") +
  theme_bw() +
  geom_hline(aes(yintercept=5),color="#434343", linetype="dashed", linewidth=0.5) +
  coord_flip()

vif_plot_1
```
   
   
### Odds Ratios and CI of Reduced Predictors    

```{r "forest plot for all pred logreg model", fig.height=10, fig.width=8}
# forest plot
library(finalfit)
# df_final %>%
#   or_plot(dependent, pred.all)
```

```{r "ORs and CIs for reduced logreg model"}
# library(broom)
# model.1 %>%
#   tidy(conf.int=TRUE, exp=TRUE) %>%
#   datatable(rownames=FALSE,
#             colnames=c("predictor", "odds ratio", "std error", "statistic", "p-value", "CI low", "CI high"),
#             options=list(pageLength=15, scrollX=T))
```

```{r "forest plot for reduced logreg model", fig.height=10, fig.width=14}
# forest plot
# library(finalfit)
#df_final %>%
#or_plot(dependent, pred.m1)
```

### Interactions
#### Interaction of Social support in different races

```{r "log reg interaction social support and race"}
Model_Int1 <- glm(wellbeing ~ 
                    age + 
                    race:SocialSupport +
                    income +
                    GeneralHealth + 
                    PoorPhysicalHealthDays + 
                    PoorMentalHealthDays + 
                    HealthInsurance + 
                    LimitedActivity + 
                    employ +
                    BMI + 
                    HeavyDrinker + 
                    CurrentSmoker + 
                    PoorSleepDays + 
                    PhysicalActivity + 
                    marital + 
                    PrematureMortality + 
                    ParkAccess + 
                    CrimeRate + 
                    WaterSafety + 
                    SomeCollegeRate, 
                  family = "binomial", df_final)
summary(Model_Int1)
```

#### Interaction of Income among different races
```{r "log reg interaction income and race"}
Model_Int2 <- glm(wellbeing ~ 
                    age + 
                    race:income +
                    SocialSupport +
                    GeneralHealth + 
                    PoorPhysicalHealthDays + 
                    PoorMentalHealthDays + 
                    HealthInsurance + 
                    LimitedActivity + 
                    employ +
                    BMI + 
                    HeavyDrinker + 
                    CurrentSmoker + 
                    PoorSleepDays + 
                    PhysicalActivity + 
                    marital + 
                    PrematureMortality + 
                    ParkAccess + 
                    CrimeRate + 
                    WaterSafety + 
                    SomeCollegeRate, 
                  family = "binomial", df_final)
summary(Model_Int2)
```


#### Interaction of race and general health 
```{r "log reg interaction race and general health"}
Model_Int3 <- glm(wellbeing ~ 
                    age + 
                    race:GeneralHealth +
                    SocialSupport +
                    income + 
                    PoorPhysicalHealthDays + 
                    PoorMentalHealthDays + 
                    HealthInsurance + 
                    LimitedActivity + 
                    employ +
                    BMI + 
                    HeavyDrinker + 
                    CurrentSmoker + 
                    PoorSleepDays + 
                    PhysicalActivity + 
                    marital + 
                    PrematureMortality + 
                    ParkAccess + 
                    CrimeRate + 
                    WaterSafety + 
                    SomeCollegeRate, 
                  family = "binomial", df_final)
summary(Model_Int3)
```

### Check statistical model performance   
```{r "compare statistical models"}
library(broom)
M1 <- glance(model.all)
M2 <- glance(model.1)
M3 <- glance(Model_Int1)
M4 <- glance(Model_Int2)
M5 <- glance(Model_Int3)

model_table <- bind_rows(M1, M2, M3, M4, M5)
datatable(model_table,
          rownames=c("All", "Reduced", "race:SocialSupport", "race:income", "race:GeneralHealth"), 
          options=list(pageLength=5,scrollX=T)) %>%
  formatRound(c(1:4:6),digits=2)
```

# Logistic Regression Using Machine Learning

## Split the Data set

```{r "partition the data into train and test sets"}
## set the seed to make your partition reproducible
set.seed(123)
train_index <- sample(seq_len(nrow(df_final)), size = 0.75*nrow(df_final))

train <- df_final[train_index, ]
test <- df_final[-train_index, ]
nrow(train)

```

```{r}
nrow(test)
```


## Train the Model

```{r}
pacman::p_load(caret)
```

```{r "LogReg ML Model"}
glm_model <- train(wellbeing ~ 
                     age + 
                     SocialSupport + 
                     race + 
                     income +  
                     GeneralHealth + 
                     PoorPhysicalHealthDays +  
                     PoorMentalHealthDays + 
                     HealthInsurance + 
                     LimitedActivity + 
                     employ + 
                     BMI + 
                     HeavyDrinker + 
                     CurrentSmoker + 
                     PoorSleepDays + 
                     PhysicalActivity +
                     marital + 
                     PrematureMortality + 
                     ParkAccess + 
                     CrimeRate + 
                     WaterSafety + 
                     SomeCollegeRate, 
                   data = train, method = "glm", family = "binomial")
attributes(glm_model)
```
```{r}
summary(glm_model)
```


## Evaluate the Model Performance

```{r}
glm_model$metric
```


```{r}
glm_model$results
```


## Check the Predictions on the Test Data Set

```{r "log reg ML model on test set"}
test$pred <- glm_model %>% predict(test)
```

## evaluate the performance-define accuracy function

```{r}
accuracy_function = function(real, predicted) {
  mean(real == predicted)
}
```

```{r "evaluate perf of log reg ML model"}
accuracy_function(real = test$wellbeing,
         predicted = test$pred)
```

## Variable Importance of the Variables Used

```{r}
ggplot(varImp(glm_model))
```


```{r, fig.width=12, fig.height=12}
ggplot(varImp(glm_model)) +
  geom_bar(stat="identity", fill="#67d1d3", colour="black") + 
  ggtitle("Impacts of Features on Wellbeing") +
  labs(y= "Relative Impacts of Features", x= "Features") +
  theme_bw() +
  theme(legend.position="none",
        axis.text.y = element_text( size=12, face="bold")) +
  expand_limits(y=0.85)
```
## Performance Metrics for Log Reg ML Model
```{r}
confusionMtx_logreg = table(test$pred,test$wellbeing)
confusionMtx_logreg
```
### Create the Confusion Matrix for Log Reg

```{r}
TP_logreg=confusionMtx_logreg[1,1]
FP_logreg=confusionMtx_logreg[1,2]
TN_logreg=confusionMtx_logreg[2,2]
FN_logreg=confusionMtx_logreg[2,1]  
TP_logreg
```
### Calcaulating Recall

```{r}
recall_logreg=TP_logreg/(TP_logreg+FN_logreg)
recall_logreg
```
### Calcualting Accuracy

```{r}
Accuracy_logreg=(TP_logreg+TN_logreg)/nrow(test)
Accuracy_logreg
```
### Calacualting Specificity
```{r}
specificity_logreg=TN_logreg/(TN_logreg+FP_logreg)
specificity_logreg
```

### Calculate Precision
```{r}
precision_logreg=TP_logreg/(TP_logreg+FP_logreg)
precision_logreg
```
### Calculate F1-score
```{r}
F1_logreg=(2*recall_logreg*precision_logreg)/(recall_logreg+precision_logreg)
F1_logreg
```
### ROC for Log Reg ML Model   
```{r "retrieve probabilities of log reg ML model for ROC"}
# retrieve probabilities
prob_logreg<- glm_model %>% predict(test,type='prob')
```
```{r}
str(prob_logreg)
```

```{r "create logreg ML model roc"}
logreg.roc=roc(predictor=prob_logreg$Good_Wellbeing,response=test$wellbeing,
             levels=levels(test$wellbeing))
```

```{r}
logreg.roc
```

```{r "plot log reg ML model roc curve"}
ggroc(logreg.roc, alpha = 1, colour = "red", linetype = 1, size =0.7 ) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="black", linetype="dashed") + 
  ggtitle("ROC Curve for Logistic Regression ML Model") +
  xlab("1 - specificity") +
  ylab("sensitivity") +
  annotate(geom="text", x=0.7, y=0.75, label="Log Reg Model classifier", color="red") +  
  annotate(geom="text", x=0.45, y=0.4, label="random classifier") +
  annotate(geom="text", x=0.1, y=0.05, label="AUC = 0.9066", color="darkred") +
  theme_bw()
```
     
     
     
# CART MODEL to predict Wellbeing


## Library Loading 
```{r}
library(rattle)
library(pROC)
library(xgboost)
library(randomForest)
```

## Split the Data
```{r}
# using same partitioned dataset as before    

# set.seed(123)
# train_index <- sample(seq_len(nrow(df_final)), size = 0.75*nrow(df_final))
# 
# train <- df_final[train_index, ]
# test <- df_final[-train_index, ]
# cat(nrow(test),nrow(train))
```



## Holdout

```{r}
levels(train$wellbeing) <- c("Good_Wellbeing", "Poor_Wellbeing")
```


```{r}
trcntrl_ho<-trainControl(classProbs = TRUE,summaryFunction = twoClassSummary)
```

## CART with Auto Hyperparameter Tuning




```{r "build CART Model"}
model_CART <- train(wellbeing ~ 
                      age + 
                      SocialSupport + 
                      race + 
                      income +  
                      GeneralHealth + 
                      PoorPhysicalHealthDays +  
                      PoorMentalHealthDays + 
                      HealthInsurance + 
                      LimitedActivity + 
                      employ + 
                      BMI + 
                      HeavyDrinker + 
                      CurrentSmoker + 
                      PoorSleepDays + 
                      PhysicalActivity +
                      marital + 
                      PrematureMortality + 
                      ParkAccess + 
                      CrimeRate + 
                      WaterSafety + 
                      SomeCollegeRate ,
                    data = train, method = "rpart",trControl=trcntrl_ho,metric="ROC",tuneLength = 10)
model_CART$results
```


```{r "plot CART Model"}
plot(model_CART)
```



## Variable Importance of the CART Model

```{r}
ggplot(varImp(model_CART))
```
```{r, fig.width=12, fig.height=12}
ggplot(varImp(model_CART)) +
  geom_bar(stat="identity", fill="#FBE1B3", colour="black") + 
  ggtitle("Impacts of Features on Wellbeing") +
  labs(y= "Relative Impacts of Features", x= "Features") +
  theme_bw() +
  theme(legend.position="none",
        axis.text.y = element_text( size=12, face="bold")) +
  expand_limits(y=0.85)
```

```{r}
print(varImp(model_CART))
```


## Plot the Tree

```{r "CART decision tree", fig.width=15}
plot(model_CART$finalModel, uniform=TRUE,
     main="Classification Tree")
text(model_CART$finalModel, all=FALSE, cex=.7)
```



```{r "CART rattle library decision tree", fig.width=15}
# Using the Rattle Library
library(rattle)
fancyRpartPlot(model_CART$finalModel,cex = 0.9)
```


## Prediction on Test Data

```{r "test CART model on holdout sample"}
test$pred_cart <- model_CART %>% predict(test)
```


```{r "get CART Model probs"}
prob_cart<- model_CART %>% predict(test,type='prob')
```

```{r}
confusionMtx=table(test$pred_cart,test$wellbeing)
confusionMtx
```

## Create the Confusion Matrix

```{r}
TP=confusionMtx[1,1]
FP=confusionMtx[1,2]
TN=confusionMtx[2,2]
FN=confusionMtx[2,1]  
TP
```
### Calcaulating Recall

```{r}
recall=TP/(TP+FN)
recall
```
### Calcualting Accuracy

```{r}
Accuracy=(TP+TN)/nrow(test)
Accuracy
```
### Calacualting Specificity
```{r}
specificity=TN/(TN+FP)
specificity
```

### Calculate Precision
```{r}
precision=TP/(TP+FP)
precision
```
### Calculate F1-score
```{r}
F1=(2*recall*precision)/(recall+precision)
F1
```
```{r}
str(prob_cart)
```
### ROC
```{r "Create ROC for CART"}
CART.roc=roc(predictor=prob_cart$Good_Wellbeing,response=test$wellbeing,
             levels=levels(test$wellbeing))
```

```{r}
CART.roc

```

```{r "plot CART ROC"}
ggroc(CART.roc, alpha = 1, colour = "red", linetype = 1, size =0.7 ) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="black", linetype="dashed") + 
  ggtitle("ROC Curve for CART Model") +
  xlab("1 - specificity") +
  ylab("sensitivity") +
  annotate(geom="text", x=0.7, y=0.75, label="CART Model classifier", color="red") +  
  annotate(geom="text", x=0.45, y=0.4, label="random classifier") +
  annotate(geom="text", x=0.1, y=0.05, label="AUC = 0.7388", color="darkred") +
  theme_bw()
```




